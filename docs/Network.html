<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Программирование мобильных приложений</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./dist/reset.css" />
    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/serif.css" id="theme" />
    <link rel="stylesheet" href="./css/highlight/androidstudio.css" />


  </head>
  <body>
    <div class="reveal">
      <div class="slides"><section  data-markdown><script type="text/template">## Сетевые запросы

![network requests](assets/network/api.jpg)

[все лекции](https://github.com/dmitryweiner/android-lectures/blob/master/README.md)

[видео]()</script></section><section  data-markdown><script type="text/template">
### Стек TCP/IP
![HTTP layers](assets/network/layers.svg)</script></section><section  data-markdown><script type="text/template">
### HTTP запрос
[Подробнее](https://developer.mozilla.org/ru/docs/Web/HTTP/Overview)

![http_request](assets/network/http_request.png)</script></section><section  data-markdown><script type="text/template">
### HTTP ответ
![http_response](assets/network/http_response.png)</script></section><section  data-markdown><script type="text/template">
### Подготовка приложения
* Добавить права в AndroidManifest.xml:
```
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    package="com.example.myapplication">
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <!-- ... -->
</manifest>
```
* Если нужно обращаться к __не HTTPS__ серверам, надо добавить в `<application>` `usesCleartextTraffic`:
```xml
<application
        android:usesCleartextTraffic="true"
>
   <!-- ... -->
</application> 
```</script></section><section  data-markdown><script type="text/template">
### Варианты
* Делать запрос с помощью `HttpURLConnection` из пакета `java.net` (ставить не надо).
* Использовать библиотеку [Ktor](https://ktor.io/) (надо ставить).</script></section><section  data-markdown><script type="text/template">
### Функция для получения данных по URL'у
```kotlin
fun getContent(url: String?, timeout: Int = 10000): String? {
    var c: HttpURLConnection? = null
    try {
        val u = URL(url)
        c = u.openConnection() as HttpURLConnection
        c.setRequestMethod("GET")
        c.setRequestProperty("Content-length", "0")
        c.setUseCaches(false)
        c.setAllowUserInteraction(false)
        c.setConnectTimeout(timeout)
        c.setReadTimeout(timeout)
        c.connect()
        val status: Int = c.getResponseCode()
        when (status) {
            200, 201 -> {
                val streamReader = InputStreamReader(c.inputStream)
                var text = ""
                streamReader.use {
                    text = it.readText()
                }
                return text
            }
        }
    } catch (ex: MalformedURLException) {
        Logger.getLogger(javaClass.name).log(Level.SEVERE, null, ex)
    } catch (ex: IOException) {
        Logger.getLogger(javaClass.name).log(Level.SEVERE, null, ex)
    } finally {
        if (c != null) {
            try {
                c.disconnect()
            } catch (ex: Exception) {
                Logger.getLogger(javaClass.name).log(Level.SEVERE, null, ex)
            }
        }
    }
    return null
}
```</script></section><section  data-markdown><script type="text/template">
### Парсим JSON
```kotlin
data class User(val id: String, val name: String)

fun getUserById(id: String): User? {
    val response = getContent(
        "https://jsonplaceholder.typicode.com/users/$id",
        1000
    )
    var jsonObject: JSONObject? = null
    try {
        jsonObject = JSONObject(response)
        val user = User(
            jsonObject.getString("id"),
            jsonObject.getString("name")
        )
        return user
    } catch (e: JSONException) {
        e.printStackTrace()
    }
    return null
}
```
* Альтернатива JSONObject: использовать библиотеку [Gson](https://github.com/google/gson/blob/master/UserGuide.md).</script></section><section  data-markdown><script type="text/template">
### Запрос с помощью потоков
```kotlin
button.setOnClickListener {
    thread {
        val user = getUserById("1")
        runOnUiThread { // выполнение в UI-треде
            // выводим имя пользователя, например
            textView.text = user.name
        }
    }
}
```</script></section><section  data-markdown><script type="text/template">
### Запрос с помощью корутин
```kotlin
button.setOnClickListener {
    // Dispatchers.IO для операций ввода-вывода
    lifecycleScope.launch(Dispatchers.IO) {
        val user = getUserById("1")
        // для обращения к UI меняем поток
        withContext(Dispatchers.Main) {
            textView.text = user?.name
        }
    }
}
```</script></section><section  data-markdown><script type="text/template">
### Слишком многословно?
* Приведённое решение страдает многословностью.
* Для удобной работы с API следует пользоваться библиотекой `Retrofit`.
</script></section><section  data-markdown><script type="text/template">
### Задачи
* Написать приложение, отображающее форму:
  <br/><label>
  ID:
  <input>
  </label>
  <button>Получить данные!</button><br/>
* При нажатии кнопки приложение обращается по адресу https://jsonplaceholder.typicode.com/posts/:id.
* После этого приложение обращается по адресу https://jsonplaceholder.typicode.com/users/:userId,  
  где `userId` получен из предыдущих данных.
* Показать экране: из post - поля `title` и `body`, из user - поля `name`, `email`.
</script></section></div>
    </div>

    <script src="./dist/reveal.js"></script>

    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/zoom/zoom.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        plugins: [
          RevealMarkdown,
          RevealHighlight,
          RevealZoom,
          RevealNotes,
          RevealMath
        ]
      };

      // options from URL query string
      var queryOptions = Reveal().getQueryHash() || {};

      var options = extend(defaultOptions, {}, queryOptions);
    </script>


    <script>
      Reveal.initialize(options);
    </script>
  </body>
</html>
